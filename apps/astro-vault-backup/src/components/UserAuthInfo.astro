---
import { getAuthFromRequestSafe, getSessionTimeRemaining, isSessionExpired } from '../lib/auth'

// Debug logging
console.log('[UserAuthInfo] All request headers:', Object.fromEntries(Astro.request.headers.entries()))

const authInfo = await getAuthFromRequestSafe(Astro.request)
if (authInfo) {
  console.log('[UserAuthInfo] Auth result:', {
    userId: authInfo.user.id,
    email: authInfo.user.email,
    hasPatronAccess: authInfo.hasPatronAccess,
    sessionExpired: isSessionExpired(authInfo.session),
    timeRemaining: Math.round(getSessionTimeRemaining(authInfo.session) / 60) + ' minutes'
  })
} else {
  console.log('[UserAuthInfo] Not authenticated')
}
---

{authInfo ? (
  <div class="auth-info">
    <div class="auth-status">
      ✅ <strong>Authenticated</strong>
    </div>
    <div class="user-details">
      <div><strong>User ID:</strong> {authInfo.user.id}</div>
      <div><strong>Email:</strong> {authInfo.user.email}</div>
      <div><strong>Patron Access:</strong> {authInfo.hasPatronAccess ? 'Yes' : 'No'}</div>
      <div><strong>Session:</strong> {isSessionExpired(authInfo.session) ? '⚠️ Expired' : '✅ Active'}</div>
      {!isSessionExpired(authInfo.session) && (
        <div><strong>Time Remaining:</strong> {Math.round(getSessionTimeRemaining(authInfo.session) / 60)} minutes</div>
      )}
      {authInfo.user.user_metadata?.full_name && (
        <div><strong>Name:</strong> {authInfo.user.user_metadata.full_name}</div>
      )}
    </div>
  </div>
) : (
  <div class="auth-info">
    <div class="auth-status">
      ❌ <strong>Not authenticated</strong>
    </div>
    <div class="auth-prompt">
      <a href="https://nimble-tools.vercel.app" class="login-link">Login via Portal</a>
    </div>
  </div>
)}

<style>
  .auth-info {
    padding: 1rem;
    margin: 1rem 0;
    border: 1px solid #ccc;
    border-radius: 8px;
    background: #f9f9f9;
  }
  
  .auth-status {
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
  }
  
  .user-details {
    font-size: 0.9rem;
    color: #666;
  }
  
  .user-tags {
    margin-top: 0.5rem;
  }
  
  .tag {
    display: inline-block;
    background: #007acc;
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    margin-right: 0.5rem;
    font-size: 0.8rem;
  }
  
  .login-link {
    color: #007acc;
    text-decoration: none;
    font-weight: bold;
  }
  
  .login-link:hover {
    text-decoration: underline;
  }
  
  .auth-prompt {
    margin-top: 0.5rem;
  }
</style>